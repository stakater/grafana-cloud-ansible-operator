- name: Debug at the start of hub spoke
  ansible.builtin.debug:
    msg: "Started processing hub spoke tasks"

- name: Add finalizer to the CR
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: grafanacloud.stakater.com/v1alpha1
      kind: Config
      metadata:
        name: "{{ grafana_cloud_operator_cr_name }}"
        namespace: "{{ grafana_cloud_operator_cr_namespace }}"
        finalizers:
          - grafanacloud.stakater.com/config
  when: "'grafanacloud.stakater.com/config' not in grafana_cloud_operator_cr.metadata.finalizers"

- name: Update CR status to Initiated
  operator_sdk.util.k8s_status:
    api_version: grafanacloud.stakater.com/v1alpha1
    kind: Config
    name: "{{ grafana_cloud_operator_cr_name }}"
    namespace: "{{ grafana_cloud_operator_cr_namespace }}"
    status:
      conditions:
        - type: Initiated
          status: "True"
          reason: OperationStarted
          message: Operation to integrate Grafana OnCall started
          lastTransitionTime: "{{ grafana_cloud_operator_ansible_date_time.iso8601 }}"

- name: Fetch current status from Config CR
  kubernetes.core.k8s_info:
    api_version: grafanacloud.stakater.com/v1alpha1
    kind: Config
    name: "{{ grafana_cloud_operator_cr_name }}"
    namespace: "{{ grafana_cloud_operator_cr_namespace }}"
  register: grafana_cloud_operator_current_config_cr

- name: Fetch ManagedClusters
  kubernetes.core.k8s_info:
    api_version: cluster.open-cluster-management.io/v1
    kind: ManagedCluster
  register: grafana_cloud_operator_managed_clusters_raw

# -------------------------------------------------------------------
# Build source-of-truth cluster → owner map
# -------------------------------------------------------------------
- name: Build ManagedCluster → owner map
  ansible.builtin.set_fact:
    grafana_cloud_operator_managed_clusters: >-
      {{
        dict(
          grafana_cloud_operator_managed_clusters_raw.resources
          | map(attribute='metadata.name')
          | zip(
              grafana_cloud_operator_managed_clusters_raw.resources
              | map(attribute='metadata.labels.owner')
              | map('default', 'unknown')
            )
        )
      }}

# -------------------------------------------------------------------
# Build structured integration objects (KEY FIX)
# -------------------------------------------------------------------
- name: Build integration objects
  ansible.builtin.set_fact:
    grafana_cloud_operator_integration_objects: >-
      {{
        grafana_cloud_operator_managed_clusters
        | dict2items
        | map(
            'combine',
            {
              'cluster_name': item.key,
              'owner': item.value,
              'integration_name': item.key ~ '-' ~ item.value
            }
          )
        | list
      }}

# Existing integrations fetched earlier (string list)
- name: Normalize existing integration names
  ansible.builtin.set_fact:
    grafana_cloud_operator_existing_integration_names_lower: >-
      {{ grafana_cloud_operator_existing_integration_names | map('lower') | list }}

- name: Filter integrations to be created
  ansible.builtin.set_fact:
    grafana_cloud_operator_create_integration_for: >-
      {{
        grafana_cloud_operator_integration_objects
        | rejectattr('integration_name', 'lower', 'in', grafana_cloud_operator_existing_integration_names_lower)
        | list
      }}

# -------------------------------------------------------------------
# Integration creation
# -------------------------------------------------------------------
- name: Create Grafana OnCall integrations
  block:

    - name: Fetch Slack Channel per cluster
      kubernetes.core.k8s_info:
        api_version: slack.stakater.com/v1alpha1
        kind: Channel
        namespace: "{{ item.cluster_name }}"
      loop: "{{ grafana_cloud_operator_create_integration_for }}"
      loop_control:
        label: "{{ item.cluster_name }}"
      register: grafana_cloud_operator_slack_channel_info

    - name: Extract Slack channel IDs
      ansible.builtin.set_fact:
        grafana_cloud_operator_slack_channel_ids: >-
          {{
            grafana_cloud_operator_slack_channel_info.results
            | map(attribute='resources')
            | flatten
            | map(attribute='status.id')
            | list
          }}

    - name: Create Grafana integrations
      ansible.builtin.uri:
        url: "{{ grafana_cloud_operator_grafana_cloud_integrations_api_url }}"
        method: POST
        headers:
          Authorization: "{{ grafana_cloud_operator_grafana_cloud_api_token }}"
          Content-Type: application/json
        body_format: json
        body:
          type: alertmanager
          name: "{{ item.integration_name }}"
          default_route:
            slack:
              channel_id: "{{ grafana_cloud_operator_slack_channel_ids[loop_index] | default('') }}"
              enabled: "{{ grafana_cloud_operator_slack_cond }}"
        status_code: [200, 201]
        return_content: true
      loop: "{{ grafana_cloud_operator_create_integration_for }}"
      loop_control:
        index_var: loop_index
        label: "{{ item.integration_name }}"
      register: grafana_cloud_operator_integration_response
      failed_when: false

    - name: Map integrations to clusters
      ansible.builtin.set_fact:
        grafana_cloud_operator_mapped_integrations: >-
          {{
            grafana_cloud_operator_mapped_integrations | default([])
            + [{
                'cluster_name': item.item.cluster_name,
                'integration_name': item.item.integration_name,
                'grafana_details': item.json
              }]
          }}
      loop: "{{ grafana_cloud_operator_integration_response.results }}"

    - name: Update CR status to IntegrationsCreated
      operator_sdk.util.k8s_status:
        api_version: grafanacloud.stakater.com/v1alpha1
        kind: Config
        name: "{{ grafana_cloud_operator_cr_name }}"
        namespace: "{{ grafana_cloud_operator_cr_namespace }}"
        status:
          conditions:
            - type: Successful
              status: "True"
              reason: IntegrationsCreated
              message: Grafana integrations created successfully
              lastTransitionTime: "{{ grafana_cloud_operator_ansible_date_time.iso8601 }}"

  when: grafana_cloud_operator_create_integration_for | length > 0

# -------------------------------------------------------------------
# Modify Alertmanager + ManifestWork (FIXED)
# -------------------------------------------------------------------
- name: Modify Alertmanager secrets via ManifestWork
  ansible.builtin.include_tasks: modify_alertmanager_secret.yml
  vars:
    receiver_name: "{{ item.integration_name }}"
    receiver_url: "{{ item.grafana_details.link }}"
    grafana_cloud_operator_cluster_name: "{{ item.cluster_name }}"
    provision_mode: hubAndSpoke
  loop: "{{ grafana_cloud_operator_mapped_integrations }}"
  loop_control:
    label: "{{ item.cluster_name }}"

# -------------------------------------------------------------------
# ManifestWork status handling
# -------------------------------------------------------------------
- name: Update CR status for ManifestWork success
  operator_sdk.util.k8s_status:
    api_version: grafanacloud.stakater.com/v1alpha1
    kind: Config
    name: "{{ grafana_cloud_operator_cr_name }}"
    namespace: "{{ grafana_cloud_operator_cr_namespace }}"
    status:
      conditions:
        - type: Successful
          status: "True"
          reason: ManifestWorksCreated
          message: ManifestWorks created for all ManagedClusters
          lastTransitionTime: "{{ grafana_cloud_operator_ansible_date_time.iso8601 }}"
  when: grafana_cloud_operator_manifestwork_creation_results is defined
        and not grafana_cloud_operator_manifestwork_creation_results.failed

- name: Update CR status for ManifestWork failure
  operator_sdk.util.k8s_status:
    api_version: grafanacloud.stakater.com/v1alpha1
    kind: Config
    name: "{{ grafana_cloud_operator_cr_name }}"
    namespace: "{{ grafana_cloud_operator_cr_namespace }}"
    status:
      conditions:
        - type: Failed
          status: "True"
          reason: ManifestWorkCreationFailed
          message: Failed to create ManifestWork
          lastTransitionTime: "{{ grafana_cloud_operator_ansible_date_time.iso8601 }}"
  when: grafana_cloud_operator_manifestwork_creation_results is defined
        and grafana_cloud_operator_manifestwork_creation_results.failed

# -------------------------------------------------------------------
# Deletion logic (unchanged)
# -------------------------------------------------------------------
- name: Start deletion for hubAndSpoke mode
  ansible.builtin.include_tasks: delete_grafana_oncall_hub_spoke.yml
  when:
    - grafana_cloud_operator_manifestwork_creation_results is not defined
    - grafana_cloud_operator_create_integration_for | length == 0
