- name: Decode and modify alertmanager secret configuration
  ansible.builtin.set_fact:
    modified_alertmanager_secret_content: >
      {{ (fetched_alertmanager_secret.resources[0].data['alertmanager.yaml'] | b64decode | from_yaml) | combine({
          "receivers": [
            {
              "name": "receiver_name",
              "webhook_configs": [{
                "url": "receiver_url"
              }]
            }
          ],
          "route": {[
            "receiver": "receiver_name",
            "routes": [
              {
                "receiver": "receiver_name",
                "match": {
                  "severity": "info | warning | critical"
                }
              }
            ]
          }]
      }, recursive=True) }}

- name: Update CR status to AlertmanagerConfigModified
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: grafanacloud.stakater.com/v1alpha1
      kind: GrafanaCloudOperator
      metadata:
        name: "{{ cr_name }}"
        namespace: "{{ cr_namespace }}"
      status:
        lastUpdated: "{{ ansible_date_time.iso8601 }}"
        phase: "Processing"
        reason: "AlertmanagerConfigModified"
        message: "Decoded and modified the alertmanager secret configuration"
